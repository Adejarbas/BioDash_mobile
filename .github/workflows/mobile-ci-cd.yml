name: Mobile CI / CD (Android)
 
permissions:
  contents: write

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
 
jobs:
  pipeline:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17' # Vers√£o recomendada para builds Android modernos
 
      - name: Depend√™ncias
        run: npm install --force      
 
      - name: Semver
        run: npm install -g semver       
 
      - name: Criar nova tag caso n√£o exista
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$(git tag)" ]; then
            git config --global user.name 'github-actions'
            git config --global user.email 'github-actions@github.com'
            git tag -a v0.0.0 -m "Initial release"
            git push origin v0.0.0
          else
            echo "Tag v0.0.0 j√° existe - nenhuma a√ß√£o necess√°ria."
          fi
 
      - name: Calcular nova vers√£o
        id: version
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force --prune
          EXISTING_TAG=$(git tag --points-at HEAD | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || true)
          if [ -n "${EXISTING_TAG:-}" ]; then
            echo "Reexecu√ß√£o detectada: usando tag existente $EXISTING_TAG"
            VERSION="${EXISTING_TAG#v}"
            {
              echo "should_deploy=false"
              echo "current_version=$VERSION"
              echo "new_version=$VERSION"
            } >> "$GITHUB_OUTPUT"
            echo "NEW_VERSION=$VERSION" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "Nenhuma tag sem√¢ntica no HEAD. Calculando nova vers√£o‚Ä¶"
          LAST_TAG=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1 || true)
          if [ -z "${LAST_TAG:-}" ]; then
            LAST_TAG="v0.0.0"
          fi
          echo "√öltima tag: $LAST_TAG"
          CURRENT_VERSION="${LAST_TAG#v}"
          if [ "$LAST_TAG" = "v0.0.0" ]; then
            LOG_RANGE=""
          else
            LOG_RANGE="${LAST_TAG}..HEAD"
          fi
          mapfile -t COMMITS < <(git log ${LOG_RANGE} --pretty=format:'%s' || true)
          echo "Commits desde ${LAST_TAG}:"
          printf ' - %s\n' "${COMMITS[@]:-<nenhum>}"
          MAJOR=0; MINOR=0; PATCH=0
          for COMMIT in "${COMMITS[@]:-}"; do
            if [[ "$COMMIT" == *"BREAKING CHANGE"* ]] || [[ "$COMMIT" =~ ^feat!\: ]] || [[ "$COMMIT" =~ \!$ ]]; then
              MAJOR=1
            elif [[ "$COMMIT" =~ ^feat(\(.+\))?\: ]]; then
              MINOR=1
            elif [[ "$COMMIT" =~ ^fix(\(.+\))?\: ]]; then
              PATCH=1
            fi
          done
          NEW_VERSION="$CURRENT_VERSION"
          if [[ $MAJOR -eq 1 ]]; then
            NEW_VERSION=$(semver -i major "$CURRENT_VERSION")
          elif [[ $MINOR -eq 1 ]]; then
            NEW_VERSION=$(semver -i minor "$CURRENT_VERSION")
          elif [[ $PATCH -eq 1 ]]; then
            NEW_VERSION=$(semver -i patch "$CURRENT_VERSION")
          fi
          echo "Vers√µes (atual / nova): $CURRENT_VERSION -> $NEW_VERSION"
          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "Sem mudan√ßas de vers√£o (sem commits feat/fix/! ou BREAKING CHANGE)."
            {
              echo "should_deploy=false"
              echo "current_version=$CURRENT_VERSION"
              echo "new_version=$CURRENT_VERSION"
            } >> "$GITHUB_OUTPUT"
            echo "NEW_VERSION=$CURRENT_VERSION" >> "$GITHUB_ENV"
          else
            {
              echo "should_deploy=true"
              echo "current_version=$CURRENT_VERSION"
              echo "new_version=$NEW_VERSION"
            } >> "$GITHUB_OUTPUT"
            echo "NEW_VERSION=$NEW_VERSION" >> "$GITHUB_ENV"
          fi

      - name: Atualizar vers√£o no package.json
        if: steps.version.outputs.should_deploy == 'true' && github.ref == 'refs/heads/main'
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          set -euo pipefail
          CURRENT_PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$CURRENT_PKG_VERSION" != "${NEW_VERSION}" ]; then
            npm version "${NEW_VERSION}" --no-git-tag-version
          else
            echo "Vers√£o $NEW_VERSION j√° est√° no package.json"
          fi

      - name: Commit e push package/tag
        if: steps.version.outputs.should_deploy == 'true' && github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore(release): version ${NEW_VERSION}" || echo "Nada para commitar"
          if git rev-parse "v${NEW_VERSION}" >/dev/null 2>&1; then
            echo "Tag v${NEW_VERSION} j√° existe. Pulando cria√ß√£o de tag."
          else
            git tag "v${NEW_VERSION}"
          fi
          git push origin HEAD:main
          if git rev-parse "v${NEW_VERSION}" >/dev/null 2>&1; then
            git push origin "v${NEW_VERSION}"
          fi

      # Build Android (React Native CLI) - Comentado por enquanto
      # - name: Build Android Release
      #   if: steps.version.outputs.should_deploy == 'true' && github.ref == 'refs/heads/main'
      #   run: |
      #     cd android
      #     chmod +x gradlew
      #     ./gradlew assembleRelease
 
      # --- PASSOS DO DOCKER (COMENTADOS CONFORME SOLICITADO) ---
      # - name: Set up Docker Buildx
      #   if: steps.version.outputs.should_deploy == 'true' && github.ref == 'refs/heads/main'
      #   uses: docker/setup-buildx-action@v3

      # - name: Login to Docker Hub
      #   if: steps.version.outputs.should_deploy == 'true' && github.ref == 'refs/heads/main'
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}

      # - name: Build and push Docker image
      #   if: steps.version.outputs.should_deploy == 'true' && github.ref == 'refs/heads/main'
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     file: ./Dockerfile
      #     push: true
      #     tags: |
      #       ${{ secrets.DOCKERHUB_USERNAME }}/biodash-frontend:latest
      #       ${{ secrets.DOCKERHUB_USERNAME }}/biodash-frontend:v${{ steps.version.outputs.new_version }}
      #     build-args: |
      #       NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      #       NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      #       LOGTAIL_TOKEN=${{ secrets.LOGTAIL_TOKEN }}
      #       LOGTAIL_URL=${{ secrets.LOGTAIL_URL }}
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      # Envio de e-mail quando pipeline FALHAR
      # - name: Enviar email se falhar
      #   if: failure()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 587
      #     secure: false
      #     username: ${{ secrets.EMAIL_USERNAME }}
      #     password: ${{ secrets.EMAIL_PASSWORD }}
      #     subject: "‚ùå Falha pipeline Actions - BioDashMobile"
      #     to: fe.dsm.vot.001@gmail.com # Email atualizado conforme pedido original
      #     from: ${{ secrets.EMAIL_USERNAME || 'github-actions@github.com' }}
      #     body: |
      #       ‚ö†Ô∏è A execu√ß√£o do pipeline FALHOU!
            
      #       üì¶ Reposit√≥rio: ${{ github.repository }}
      #       üîñ Commit: ${{ github.sha }}
      #       ‚öôÔ∏è Workflow: ${{ github.workflow }}
      #       üîß Job: ${{ github.job }}
      #       üë§ Autor: ${{ github.actor }}
      #       üåø Branch: ${{ github.ref_name }}
            
      #       üîó Ver logs completos: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
      #       --
      #       Notifica√ß√£o autom√°tica do GitHub Actions

      # Envio de e-mail quando pipeline tiver SUCESSO
      # - name: Enviar email de sucesso
      #   if: success()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 587
      #     secure: false
      #     username: ${{ secrets.EMAIL_USERNAME }}
      #     password: ${{ secrets.EMAIL_PASSWORD }}
      #     subject: "‚úÖ Pipeline BioDashMobile executado com sucesso!"
      #     to: fe.dsm.vot.001@gmail.com # Email atualizado conforme pedido original
      #     from: ${{ secrets.EMAIL_USERNAME || 'github-actions@github.com' }}
      #     body: |
      #       üéâ Pipeline executado com SUCESSO!
            
      #       üì¶ Reposit√≥rio: ${{ github.repository }}
      #       üîñ Commit: ${{ github.sha }}
      #       ‚öôÔ∏è Workflow: ${{ github.workflow }}
      #       üîß Job: ${{ github.job }}
      #       üë§ Autor: ${{ github.actor }}
      #       üåø Branch: ${{ github.ref_name }}
      #       üìå Vers√£o: v${{ steps.version.outputs.new_version }}
            
      #       üîó Ver detalhes: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
      #       --
      #       Notifica√ß√£o autom√°tica do GitHub Actions
